<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão de Projetos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Styles for manual content */
        .manual-content h2 { font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; }
        .manual-content h3 { font-size: 1.25rem; font-weight: 600; color: #374151; margin-top: 1.25rem; margin-bottom: 0.75rem; }
        .manual-content h4 { font-size: 1.1rem; font-weight: 600; color: #4b5563; margin-top: 1rem; margin-bottom: 0.5rem; }
        .manual-content p, .manual-content li { color: #4b5563; line-height: 1.6; }
        .manual-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .manual-content strong { color: #1f2937; }
        .manual-content .highlight { background-color: #fef3c7; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-weight: 500; }
        
        /* Kanban board styles */
        .kanban-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .kanban-column { background-color: #f9fafb; border-radius: 0.75rem; padding: 1rem; border: 1px solid #e5e7eb; min-height: 400px; }
        .kanban-column-title { font-size: 1.125rem; font-weight: 600; color: #111827; margin-bottom: 1rem; display: flex; align-items: center; }
        .kanban-card { 
            background-color: #ffffff; 
            border-radius: 0.5rem; 
            padding: 1rem; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); 
            margin-bottom: 1rem; 
            border-left: 4px solid #e5e7eb; 
            transition: border-color: 0.3s ease, box-shadow: 0.3s ease; 
        }
        .kanban-card.current-step {
            border-left-color: #3b82f6;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2), 0 2px 4px -1px rgba(59, 130, 246, 0.1);
        }
        .kanban-card.completed-step {
            border-left-color: #22c55e;
            opacity: 0.7;
        }
        .kanban-card-button { background-color: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; text-align: center; cursor: pointer; transition: background-color: 0.2s; }
        .kanban-card-button:hover { background-color: #2563eb; }
        .kanban-card-button:disabled { background-color: #9ca3af; cursor: not-allowed; }

        /* To-do list styles */
        .todo-item { display: flex; align-items: center; padding: 0.75rem; background-color: #fff; border-radius: 0.5rem; margin-bottom: 0.5rem; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        .todo-item.completed .todo-text { text-decoration: line-through; color: #9ca3af; }
        .todo-item input[type="checkbox"] { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; cursor: pointer; flex-shrink: 0; }
        .todo-details { flex-grow: 1; }
        .todo-text { display: block; }
        .assignee-tag { background-color: #e0e7ff; color: #4338ca; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; margin-top: 0.25rem; display: inline-block;}
        .delete-todo { background: none; border: none; cursor: pointer; color: #ef4444; flex-shrink: 0; }
        .todo-deadline { display: inline-block; font-size: 0.75rem; color: #4b5563; margin-top: 0.25rem; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        
        /* New styling for project-specific Kanban boards */
        .project-kanban-section {
            display: none;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .project-kanban-section.active {
            display: flex;
        }
        .project-kanban-section h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        /* Financial table specific styles */
        .editable-cell {
            padding: 0.25rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.1s ease-in-out;
            min-width: 80px; /* Adjust as needed */
        }
        .editable-cell:hover {
            border-color: #e5e7eb;
            background-color: #f9fafb;
        }
        .editable-cell.editing {
            border-color: #3b82f6;
            background-color: #fff;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .editable-cell input {
            width: 100%;
            border: none;
            outline: none;
            background: none;
            text-align: right; /* Adjust alignment as needed */
        }
        .financial-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
        }
        .financial-actions button {
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .financial-actions button:hover {
            background-color: #e5e7eb;
        }
        .financial-status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            text-align: center;
        }
        .status-pending { background-color: #fef3c7; color: #b45309; } /* Yellow-orange for pending */
        .status-paid, .status-received, .status-pago { background-color: #d1fae5; color: #065f46; } /* Green for paid/received */
        .status-partially_paid, .status-partially_received { background-color: #bfdbfe; color: #1e40af; } /* Blue for partially */
        .status-overdue { background-color: #fee2e2; color: #991b1b; } /* Red for overdue */

    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- Login Section -->
    <section id="auth-section" class="flex flex-col items-center justify-center min-h-screen bg-gray-100">
        <div class="p-8 bg-white rounded-xl shadow-lg w-full max-w-sm">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Acesso ao Painel</h2>
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
            </div>
            <div class="mb-6 relative">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none pr-10">
                <button id="toggle-password" type="button" class="absolute inset-y-0 right-0 top-6 pr-3 flex items-center text-gray-600">
                    <i data-lucide="eye" class="h-5 w-5"></i>
                </button>
            </div>
            <div class="space-y-4">
                <button id="login-button" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">Entrar</button>
            </div>
            <p id="auth-message" class="mt-4 text-center text-sm text-red-500"></p>
        </div>
    </section>

    <!-- Main Dashboard Section -->
    <section id="main-dashboard" class="max.w-7xl mx-auto hidden">
        <header class="mb-6 flex items-center justify-between">
            <div class="flex items-center">
                <!-- Alteração aqui: Usei um proxy de imagem para garantir a exibição -->
                <img src="https://images.weserv.nl/?url=raw.githubusercontent.com/Jacquei4/RPO_ANEEL/main/i4_v1-Photoroom.png" alt="Logo i4" class="h-14 mr-4 rounded">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Painel de Gestão de Projetos</h1>
                    <p class="text-gray-500 mt-1">Seu guia central para processos de faturamento e pagamentos.</p>
                    <div class="mt-2 text-sm text-gray-500">
                        <span class="font-semibold">Usuário:</span> <span id="user-email">Carregando...</span>
                    </div>
                </div>
            </div>
            <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-colors">
                <i data-lucide="log-out" class="h-4 w-4 mr-2"></i>Sair
            </button>
        </header>

        <!-- Tabs Container -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
            <!-- Tab Buttons -->
            <div class="border-b border-gray-200">
                <nav class="flex flex-wrap -mb-px p-2" aria-label="Tabs">
                    <button onclick="changeTab(event, 'acompanhamento-geral')" class="tab-button active text-gray-600 hover:text-blue-600 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm transition-colors duration-200">
                        <i data-lucide="layout-dashboard" class="inline-block mr-2 h-4 w-4"></i>Acompanhamento Geral
                    </button>
                    <button onclick="changeTab(event, 'kanban-por-projeto')" class="tab-button text-gray-600 hover:text-blue-600 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm transition-colors duration-200">
                        <i data-lucide="kanban" class="inline-block mr-2 h-4 w-4"></i>Kanban por Projeto
                    </button>
                    <button onclick="changeTab(event, 'todolist')" class="tab-button text-gray-600 hover:text-blue-600 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm transition-colors duration-200">
                        <i data-lucide="check-square" class="inline-block mr-2 h-4 w-4"></i>To-Do List
                    </button>
                    <button onclick="changeTab(event, 'financeiro')" class="tab-button text-gray-600 hover:text-blue-600 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm transition-colors duration-200">
                        <i data-lucide="dollar-sign" class="inline-block mr-2 h-4 w-4"></i>Financeiro Detalhado
                    </button>
                    <button onclick="changeTab(event, 'reembolsos')" class="tab-button text-gray-600 hover:text-blue-600 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm transition-colors duration-200">
                        <i data-lucide="receipt" class="inline-block mr-2 h-4 w-4"></i>Reembolsos
                    </button>
                    <button onclick="changeTab(event, 'manual')" class="tab-button text-gray-600 hover:text-blue-600 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm transition-colors duration-200">
                        <i data-lucide="book-open" class="inline-block mr-2 h-4 w-4"></i>Manual de Processos
                    </button>
                    <button onclick="changeTab(event, 'activity-log')" class="tab-button text-gray-600 hover:text-blue-600 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm transition-colors duration-200">
                        <i data-lucide="history" class="inline-block mr-2 h-4 w-4"></i>Registro de Atividades
                    </button>
                    <button id="admin-button" onclick="changeTab(event, 'admin-panel')" class="tab-button text-gray-600 hover:text-blue-600 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm transition-colors duration-200 hidden">
                        <i data-lucide="users" class="inline-block mr-2 h-4 w-4"></i>Painel Admin
                    </button>
                </nav>
            </div>

            <!-- Tab Content Panels -->
            <div class="p-6">
                <!-- Acompanhamento Geral Tab (New section for a consolidated view) -->
                <div id="acompanhamento-geral" class="tab-content active space-y-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Status Operacional dos Projetos</h2>
                        <div class="bg-gray-100 rounded-lg p-6 grid grid-cols-2 md:grid-cols-4 gap-4 items-center text-center shadow-inner">
                            <div>
                                <p class="text-sm font-semibold text-gray-500">Projetos em Andamento</p>
                                <span class="text-4xl font-extrabold text-blue-600">5</span>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-500">Concluído (Ciclo)</p>
                                <span class="text-4xl font-extrabold text-green-600" id="completed-projects-count">0</span>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-500">Aguardando Cliente</p>
                                <span class="text-4xl font-extrabold text-yellow-600" id="waiting-projects-count">0</span>
                            </div>
                             <button id="reset-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-colors col-span-2 md:col-span-1">
                                <i data-lucide="refresh-cw" class="h-4 w-4 mr-2"></i>Reiniciar Ciclo
                            </button>
                        </div>
                    </div>

                    <div id="general-view-table-container">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Próximas Ações por Projeto</h3>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Projeto</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Próxima Ação</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prazo</th>
                                    </tr>
                                </thead>
                                <tbody id="general-view-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Table rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- NEW FINANCIAL SUMMARY SECTION -->
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Resumo Financeiro Geral</h2>
                        <div class="space-y-6">
                            <!-- Faturamento Group -->
                            <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                                <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center"><i data-lucide="trending-up" class="h-5 w-5 mr-2 text-blue-500"></i>Resumo de Faturamento</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div class="bg-white p-4 rounded-lg shadow flex items-start justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-500">Total já Faturado</p>
                                            <span id="geral-total-faturado" class="text-2xl font-bold text-green-600">R$ 0,00</span>
                                        </div>
                                        <i data-lucide="check-circle" class="h-6 w-6 text-green-400"></i>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg shadow flex items-start justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-500">Previsto Faturar</p>
                                            <span id="geral-previsto-faturamento" class="text-2xl font-bold text-yellow-600">R$ 0,00</span>
                                        </div>
                                        <i data-lucide="calendar-clock" class="h-6 w-6 text-yellow-400"></i>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg shadow flex items-start justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-500">Valor Total (Contratos)</p>
                                            <span id="geral-total-contratos" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
                                        </div>
                                        <i data-lucide="file-text" class="h-6 w-6 text-blue-400"></i>
                                    </div>
                                </div>
                            </div>
                            <!-- Pagamentos Group -->
                            <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                                <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center"><i data-lucide="trending-down" class="h-5 w-5 mr-2 text-red-500"></i>Resumo de Pagamentos</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div class="bg-white p-4 rounded-lg shadow flex items-start justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-500">Total já Pago</p>
                                            <span id="geral-total-pago" class="text-2xl font-bold text-green-600">R$ 0,00</span>
                                        </div>
                                        <i data-lucide="check-circle" class="h-6 w-6 text-green-400"></i>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg shadow flex items-start justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-500">Previsto Pagar</p>
                                            <span id="geral-previsto-pagamento" class="text-2xl font-bold text-yellow-600">R$ 0,00</span>
                                        </div>
                                        <i data-lucide="calendar-clock" class="h-6 w-6 text-yellow-400"></i>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg shadow flex items-start justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-500">Custo Total Previsto</p>
                                            <span id="geral-total-a-pagar" class="text-2xl font-bold text-red-600">R$ 0,00</span>
                                        </div>
                                        <i data-lucide="file-text" class="h-6 w-6 text-red-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                            <div>
                                <h3 class="text-xl font-bold text-gray-700 mb-4">Financeiro por Projeto</h3>
                                <div class="bg-white rounded-lg shadow overflow-hidden">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Projeto</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Faturamento</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Pagamentos</th>
                                            </tr>
                                        </thead>
                                        <tbody id="geral-financial-summary-table-body" class="bg-white divide-y divide-gray-200">
                                            <!-- Summary rows will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-700 mb-4">Fluxo Financeiro (Realizado vs. Pendente)</h3>
                                <div class="bg-white rounded-lg shadow p-4">
                                    <canvas id="financial-health-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- NEW TIME SERIES CHART SECTION -->
                        <div class="mt-8">
                            <h3 class="text-xl font-bold text-gray-700 mb-4">Evolução Financeira Mensal (Valores Realizados)</h3>
                            <div class="bg-white rounded-lg shadow p-4">
                                <canvas id="financial-timeseries-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kanban por Projeto Tab (Detailed Kanban boards) -->
                <div id="kanban-por-projeto" class="tab-content">
                    <p class="text-gray-500 text-sm mb-4">Clique nos botões abaixo para visualizar os detalhes de cada projeto.</p>
                    <div class="flex flex-wrap gap-4 mb-6">
                        <button onclick="showProjectKanban('energisa')" class="project-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Energisa</button>
                        <button onclick="showProjectKanban('equatorial')" class="project-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Equatorial</button>
                        <button onclick="showProjectKanban('light_sandbox')" class="project-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Light (Sandbox)</button>
                        <button onclick="showProjectKanban('light_pid')" class="project-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Light (P&D)</button>
                        <button onclick="showProjectKanban('pesquisadores')" class="project-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Pesquisadores</button>
                    </div>

                    <!-- Individual Kanban boards for each project -->
                    <div id="kanban-energisa" class="project-kanban-section active">
                        <h3>Sandbox Energisa</h3>
                        <div class="kanban-board">
                            <div id="col-energisa-todo" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="play-circle" class="mr-2 text-blue-500"></i>A Fazer</h3>
                            </div>
                            <div id="col-energisa-in-progress" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="loader-2" class="mr-2 text-yellow-500"></i>Em Andamento</h3>
                            </div>
                            <div id="col-energisa-done" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="check-circle-2" class="mr-2 text-green-500"></i>Concluído</h3>
                            </div>
                        </div>
                    </div>

                    <div id="kanban-equatorial" class="project-kanban-section">
                        <h3>Sandbox Equatorial</h3>
                        <div class="kanban-board">
                             <div id="col-equatorial-todo" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="play-circle" class="mr-2 text-blue-500"></i>A Fazer</h3>
                            </div>
                            <div id="col-equatorial-in-progress" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="loader-2" class="mr-2 text-yellow-500"></i>Em Andamento</h3>
                            </div>
                            <div id="col-equatorial-done" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="check-circle-2" class="mr-2 text-green-500"></i>Concluído</h3>
                            </div>
                        </div>
                    </div>

                    <div id="kanban-light_sandbox" class="project-kanban-section">
                        <h3>Sandbox Light</h3>
                        <div class="kanban-board">
                             <div id="col-light_sandbox-todo" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="play-circle" class="mr-2 text-blue-500"></i>A Fazer</h3>
                            </div>
                            <div id="col-light_sandbox-in-progress" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="loader-2" class="mr-2 text-yellow-500"></i>Em Andamento</h3>
                            </div>
                            <div id="col-light_sandbox-done" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="check-circle-2" class="mr-2 text-green-500"></i>Concluído</h3>
                            </div>
                        </div>
                    </div>
                    
                    <div id="kanban-light_pid" class="project-kanban-section">
                        <h3>P&D Light (Por Sprint)</h3>
                        <div class="kanban-board">
                             <div id="col-light_pid-todo" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="play-circle" class="mr-2 text-blue-500"></i>A Fazer</h3>
                            </div>
                            <div id="col-light_pid-in-progress" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="loader-2" class="mr-2 text-yellow-500"></i>Em Andamento</h3>
                            </div>
                            <div id="col-light_pid-done" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="check-circle-2" class="mr-2 text-green-500"></i>Concluído</h3>
                            </div>
                        </div>
                    </div>

                    <div id="kanban-pesquisadores" class="project-kanban-section">
                        <h3>Pagamento Pesquisadores</h3>
                        <div class="kanban-board">
                             <div id="col-pesquisadores-todo" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="play-circle" class="mr-2 text-blue-500"></i>A Fazer</h3>
                            </div>
                            <div id="col-pesquisadores-in-progress" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="loader-2" class="mr-2 text-yellow-500"></i>Em Andamento</h3>
                            </div>
                            <div id="col-pesquisadores-done" class="kanban-column">
                                <h3 class="kanban-column-title"><i data-lucide="check-circle-2" class="mr-2 text-green-500"></i>Concluído</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- To-Do List Tab -->
                <div id="todolist" class="tab-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Lista de Tarefas</h2>
                    <div class="flex flex-col sm:flex-row gap-2 mb-4">
                        <input type="text" id="new-todo-input" class="flex-grow border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Adicionar nova tarefa...">
                        <input type="text" id="new-todo-assignee" class="sm:w-48 border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Encarregado...">
                        <input type="date" id="new-todo-deadline" class="sm:w-48 border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Prazo...">
                        <button id="add-todo-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Adicionar</button>
                    </div>
                    <div id="todo-list-container" class="bg-gray-50 p-4 rounded-lg">
                        <!-- To-do items will be injected here -->
                    </div>
                </div>

                <!-- Financial Dashboard Tab -->
                <div id="financeiro" class="tab-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Acompanhamento Financeiro Detalhado</h2>
                     <div class="space-y-6 mb-6">
                        <!-- Faturamento Group -->
                        <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center"><i data-lucide="trending-up" class="h-5 w-5 mr-2 text-blue-500"></i>Resumo de Faturamento (Filtrado)</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div class="bg-white p-4 rounded-lg shadow flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Total já Faturado</p>
                                        <span id="detalhado-total-faturado" class="text-2xl font-bold text-green-600">R$ 0,00</span>
                                    </div>
                                    <i data-lucide="check-circle" class="h-6 w-6 text-green-400"></i>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Previsto Faturar</p>
                                        <span id="detalhado-previsto-faturamento" class="text-2xl font-bold text-yellow-600">R$ 0,00</span>
                                    </div>
                                    <i data-lucide="calendar-clock" class="h-6 w-6 text-yellow-400"></i>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Valor Total (Contratos)</p>
                                        <span id="detalhado-total-contratos" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
                                    </div>
                                    <i data-lucide="file-text" class="h-6 w-6 text-blue-400"></i>
                                </div>
                            </div>
                        </div>
                        <!-- Pagamentos Group -->
                        <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center"><i data-lucide="trending-down" class="h-5 w-5 mr-2 text-red-500"></i>Resumo de Pagamentos (Filtrado)</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div class="bg-white p-4 rounded-lg shadow flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Total já Pago</p>
                                        <span id="detalhado-total-pago" class="text-2xl font-bold text-green-600">R$ 0,00</span>
                                    </div>
                                    <i data-lucide="check-circle" class="h-6 w-6 text-green-400"></i>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Previsto Pagar</p>
                                        <span id="detalhado-previsto-pagamento" class="text-2xl font-bold text-yellow-600">R$ 0,00</span>
                                    </div>
                                    <i data-lucide="calendar-clock" class="h-6 w-6 text-yellow-400"></i>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Custo Total Previsto</p>
                                        <span id="detalhado-total-a-pagar" class="text-2xl font-bold text-red-600">R$ 0,00</span>
                                    </div>
                                    <i data-lucide="file-text" class="h-6 w-6 text-red-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Filters & Project Selector -->
                    <div class="bg-white p-4 rounded-lg shadow-sm mb-4 flex flex-wrap gap-4 items-center">
                        <h3 class="font-bold text-gray-700">Filtrar por:</h3>
                        <select id="financial-filter-type" class="p-2 border rounded-md">
                            <option value="all">Tipo (Todos)</option>
                            <option value="receivable">Faturamento</option>
                            <option value="payment">Pagamento</option>
                        </select>
                        <select id="financial-filter-status" class="p-2 border rounded-md">
                            <option value="all">Status (Todos)</option>
                            <option value="pending">Pendente</option>
                            <option value="paid">Pago</option>
                            <option value="received">Recebido</option>
                            <option value="partially_paid">Parcialmente Pago</option>
                            <option value="partially_received">Parcialmente Recebido</option>
                            <option value="overdue">Vencido</option>
                        </select>
                        <select id="financial-filter-project" class="p-2 border rounded-md">
                            <option value="all">Projeto (Todos)</option>
                            <option value="energisa">Energisa</option>
                            <option value="equatorial">Equatorial</option>
                            <option value="light_sandbox">Light (Sandbox)</option>
                            <option value="light_pid">Light (P&D)</option>
                            <option value="pesquisadores">Pesquisadores</option>
                        </select>
                        <select id="financial-filter-year" class="p-2 border rounded-md">
                            <!-- Year options will be populated by JS -->
                        </select>
                        <button id="clear-financial-filters" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Limpar Filtros</button>
                    </div>
                    
                    <!-- Project Observation Section -->
                    <div id="project-observation-section" class="bg-white p-4 rounded-lg shadow-sm mb-4 hidden">
                        <h3 id="project-observation-title" class="font-bold text-gray-700 mb-2">Observações do Projeto</h3>
                        <textarea id="project-observation-textarea" class="w-full h-24 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Adicione observações sobre aditivos de contrato, negociações, etc..."></textarea>
                        <div class="flex justify-end mt-2">
                            <button id="save-project-observation-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Salvar Observação</button>
                        </div>
                    </div>

                    <!-- Financial Entries Table -->
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Projeto</th>
                                    <th scope="col" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Previsto</th>
                                    <th scope="col" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Realizado</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimento</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observações</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="financial-entries-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Financial entries will be inserted here -->
                            </tbody>
                        </table>
                        <div id="no-financial-data" class="p-4 text-center text-gray-500 hidden">Nenhum dado financeiro encontrado para os filtros selecionados.</div>
                    </div>
                </div>

                <!-- NEW REIMBURSEMENTS TAB -->
                <div id="reembolsos" class="tab-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Gestão de Reembolsos</h2>
                    
                    <!-- Add New Reimbursement Form -->
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Solicitar Novo Reembolso</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                            <div class="lg:col-span-1">
                                <label for="reimbursement-description" class="block text-sm font-medium text-gray-700">Descrição</label>
                                <input type="text" id="reimbursement-description" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="reimbursement-requester" class="block text-sm font-medium text-gray-700">Solicitante</label>
                                <input type="text" id="reimbursement-requester" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="reimbursement-beneficiary" class="block text-sm font-medium text-gray-700">Beneficiário</label>
                                <input type="text" id="reimbursement-beneficiary" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="reimbursement-project" class="block text-sm font-medium text-gray-700">Projeto</label>
                                <select id="reimbursement-project" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="energisa">Energisa</option>
                                    <option value="equatorial">Equatorial</option>
                                    <option value="light_sandbox">Light (Sandbox)</option>
                                    <option value="light_pid">Light (P&D)</option>
                                    <option value="pesquisadores">Pesquisadores</option>
                                    <option value="geral">Geral/Administrativo</option>
                                </select>
                            </div>
                            <div>
                                <label for="reimbursement-amount" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                                <input type="number" id="reimbursement-amount" step="0.01" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                             <div>
                                <label for="reimbursement-date" class="block text-sm font-medium text-gray-700">Data da Despesa</label>
                                <input type="date" id="reimbursement-date" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4 items-end">
                            <div class="lg:col-span-2">
                                <label for="reimbursement-file" class="block text-sm font-medium text-gray-700">Comprovante</label>
                                <input type="text" id="reimbursement-file" placeholder="Cole o link para o comprovante aqui" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                             <div class="flex justify-start">
                                <button id="add-reimbursement-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full md:w-auto">Adicionar Reembolso</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reimbursements Table -->
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descrição</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Beneficiário</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Projeto</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Valor</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data Despesa</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="reimbursements-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Reimbursement rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>


                <!-- Manual Content -->
                <div id="manual" class="tab-content manual-content">
                    <h2>Capítulo 1: Faturamento - Projeto Sandbox Energisa</h2>
                    <p>O processo da Energisa é bem estruturado e depende do cumprimento de prazos para a emissão de um relatório de acompanhamento.</p>
                    <h3>Marco de Medição:</h3>
                    <p><strong>Relatório Interno de Acompanhamento:</strong> Este é o documento que autoriza o início do processo de faturamento. Ele detalha todo o avanço do projeto no mês de referência.</p>
                    <h3>Prazos Chave:</h3>
                    <ul>
                        <li><strong>Até dia 8 do mês:</strong> Data limite para enviar o Relatório de Acompanhamento. <span class="highlight">Meta Ideal: Enviar no último dia útil do mês de referência.</span></li>
                        <li><strong>Dias 14 a 17:</strong> Período esperado para receber o e-mail da Energisa com o "Documento de Medição".</li>
                        <li><strong>Dias 20 a 23:</strong> Janela para emissão e submissão da Nota Fiscal no portal da Energisa.</li>
                        <li><strong>Recebimento:</strong> O pagamento ocorre <strong>60 dias</strong> após a emissão da nota.</li>
                    </ul>
                    <h4>Rastreabilidade de Documentos:</h4>
                    <ul>
                        <li><a href="https://i4solucoeseconsultoriaemene-my.sharepoint.com/personal/camila_i4economicregulation_com_br/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fcamila%5Fi4economicregulation%5Fcom%5Fbr%2FDocuments%2Fi4%2FENERGISA%2Fproj%5FSandbox%5F2023%2Fgest%2FGest%C3%A3o%20de%20Faturamento%20%2D%20SANDBOX%2FNFe&ga=1" target="_blank" class="text-blue-600 hover:underline">Pasta com Notas Fiscais - Sandbox Energisa</a></li>
                    </ul>
                    <h2>Capítulo 2: Faturamento - Projeto Sandbox Equatorial</h2>
                    <p>O processo da Equatorial é descrito como mais manual e exige uma ação de assinatura do Gabardo.</p>
                    <h3>Prazos Chave:</h3>
                    <ul>
                        <li><strong>Dia 30 ou 1º:</strong> Data limite para enviar o Relatório de Avanço. <span class="highlight">O não cumprimento deste prazo causa atraso.</span></li>
                        <li><strong>Dias 10 a 16:</strong> Período para receber as informações de medição para a plataforma ROIT.</li>
                        <li><strong>Dia 15:</strong> Se as informações não chegarem, cobrar a Jéssica.</li>
                        <li><strong>Dias 18 a 23:</b> Janela para emissão e submissão da Nota Fiscal.</li>
                    </ul>
                        <h3>Ação Pós-Submissão (Importante):</h3>
                    <p>Após submeter a nota, tire um print da confirmação e responda ao e-mail da Jéssica, <strong>anexando a Nota Fiscal em PDF e o comprovante/número do protocolo</strong>. Isso evita cobranças futuras.</p>
                    <h4>Rastreabilidade de Documentos:</h4>
                    <ul>
                        <li><a href="https://i4solucoeseconsultoriaemene-my.sharepoint.com/personal/camila_i4economicregulation_com_br/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fcamila%5Fi4economicregulation%5Fcom%5Fbr%2FDocuments%2Fi4%2FEQUATORIAL%2Fproj%5FSandbox%5F2023%2Fgest%2FGest%C3%A3o%20de%20Faturamento%20%2D%20SANDBOX%2FNFe&ga=1" target="_blank" class="text-blue-600 hover:underline">Pasta com Notas Fiscais - Sandbox Equatorial</a></li>
                    </ul>
                    <h2>Capítulo 3: Faturamento - Projetos Light (Sandbox e P&D)</h2>
                    <p>A Light possui dois projetos com modelos de faturamento distintos: um mensal (Sandbox) e um por entrega (P&D). Ambos exigem uma prestação de contas mensal rigorosa através da plataforma Channel.</p>
                    
                    <h4>3.1. Faturamento - Sandbox Light (Mensal)</h4>
                    
                    <h4 class="mt-4">Etapa 1: Prestação de Contas (Pré-faturamento)</h4>
                    <p>A prestação de contas deve ser submetida no Channel <span class="highlight">até o último dia útil de cada mês</span>. É composta por 5 documentos:</p>
                    <ul>
                        <li><strong>1. Comprovação de HH:</strong> (Precisa ser assinado pelo Hálisson)</li>
                        <li><strong>2. Declaração HH:</strong> (Precisa ser assinado pelo Hálisson)</li>
                        <li><strong>3. Declaração OU:</strong> (Precisa ser assinado pelo Hálisson)</li>
                        <li><strong>4. Documentação Comprobatória:</strong> (Enviado em anexo)</li>
                        <li><strong>5. Cadernos de Viagens:</strong> (Apenas se houver viagens no mês)</li>
                    </ul>

                    <h4 class="mt-4">Etapa 2: Faturamento (Pós-aprovação)</h4>
                    <p>O faturamento é realizado mensalmente, <span class="highlight">após a aprovação</span> da prestação de contas, seguindo as seguintes etapas:</p>
                    <ul>
                        <li><strong>1. Solicitar Faturamento:</strong> Através da plataforma Channel.</li>
                        <li><strong>2. Receber Documento de Medição:</strong> Aguardar o documento por e-mail.</li>
                        <li><strong>3. Solicitar NFe:</strong> Pedir que a Cássia faça a emissão da Nota Fiscal Eletrônica.</li>
                        <li><strong>4. Submissão Final:</strong> Submeter a NFe na plataforma WebSupply.</li>
                    </ul>
                    <h4>Rastreabilidade de Documentos:</h4>
                    <ul>
                        <li><a href="https://i4solucoeseconsultoriaemene-my.sharepoint.com/personal/camila_i4economicregulation_com_br/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fcamila%5Fi4economicregulation%5Fcom%5Fbr%2FDocuments%2Fi4%2FLIGHT%2Fproj%5FSandbox%5F2024%2Fgest%2FGest%C3%A3o%20de%20Faturamento%20%2D%20SANDBOX%2FNFe&ga=1" target="_blank" class="text-blue-600 hover:underline">Pasta com Notas Fiscais - Sandbox Light</a></li>
                    </ul>
                    <h4>3.2. Faturamento - P&D Light (Por Sprint)</h4>
                    
                    <h4 class="mt-4">Etapa 1: Prestação de Contas (Mensal)</h4>
                    <p>Assim como o Sandbox, a prestação de contas deve ser submetida no Channel <span class="highlight">até o último dia útil de cada mês</span>. É composta por 5 documentos:</p>
                    <ul>
                        <li><strong>1. Comprovação de HH:</strong> (Precisa ser assinado pelo Hálisson)</li>
                        <li><strong>2. Declaração HH:</strong> (Precisa ser assinado pelo Hálisson)</li>
                        <li><strong>3. Declaração OU:</strong> (Precisa ser assinado pelo Hálisson)</li>
                        <li><strong>4. OE e KR:</strong> (Precisa ser assinado pelo Hálisson)</li>
                        <li><strong>5. Documentação Comprobatória:</strong> (Enviado em anexo)</li>
                    </ul>

                    <h4 class="mt-4">Etapa 2: Faturamento (Por Sprint/Entrega)</h4>
                    <p>O faturamento <strong>não é mensal</strong>. Ocorre a cada <strong>4 meses</strong>, atrelado à conclusão de um "sprint" e à <strong>entrega de um produto</strong>. O faturamento é realizado somente quando há uma entrega de produto para ser faturada. Se a entrega atrasar, o faturamento também atrasa.</p>
                    <p>O fluxo de prestação de contas é mensal, mas o faturamento é condicional e segue o mesmo processo do Sandbox (Solicitação no Channel, NFe, Submissão no WebSupply) <span class="highlight">apenas quando uma entrega é concluída</span>.</p>
                    <h4>Rastreabilidade de Documentos:</h4>
                    <ul>
                        <li><a href="https://i4solucoeseconsultoriaemene-my.sharepoint.com/personal/camila_i4economicregulation_com_br/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fcamila%5Fi4economicregulation%5Fcom%5Fbr%2FDocuments%2Fi4%2FLIGHT%2Fproj%5FSandbox%5F2024%2Fgest%2FGest%C3%A3o%20de%20Faturamento%20%2D%20PeD%2FNFe&ga=1" target="_blank" class="text-blue-600 hover:underline">Pasta com Notas Fiscais - P&D Light</a></li>
                    </ul>

                    <h2>Capítulo 4: Pagamento dos Pesquisadores</h2>
                    <p>Este processo é padronizado para todos os projetos e pesquisadores.</p>
                        <ul>
                        <li><strong>1º dia útil do mês:</strong> Enviar e-mail de lembrete para todos.</li>
                        <li><strong>Até o dia ~7 (definido na planilha):</strong> Data limite para os pesquisadores emitirem e submeterem suas NFs.</li>
                        <li><strong>Antes do dia 10:</strong> Conferir tudo e enviar a relação de pagamentos para o Gabardo.</li>
                        <li><strong>Dia 10:</strong> Data do pagamento aos pesquisadores.</li>
                    </ul>
                    <p>É crucial cobrar ativamente os pesquisadores para que cumpram o prazo.</p>

                    <h2>Capítulo 5: Mapeamento de Pessoal por Projeto</h2>
                        <ul>
                        <li><strong>Sandbox Equatorial & Energisa:</strong> Professores (Melonei, Lucinda, Moita), Alunos (Luan, Lucas, Luís Rocha).</li>
                        <li><strong>Sandbox Light:</strong> Professores (Melonei, Moita, Lucinda), Alunos (Luan, Lucas, Diogo).</li>
                    </ul>

                    <h2>Capítulo 6: Guia Detalhado de Reembolsos</h2>
                    <h3>Princípios Fundamentais de Reembolsos</h3>
                    <h4>1. Natureza do Reembolso</h4>
                    <ul>
                        <li><strong>Definição:</strong> Ressarcimento de despesas específicas relacionadas a projetos.</li>
                        <li><strong>Característica Principal:</strong> Verba variável e não incluída diretamente na nota fiscal.</li>
                    </ul>
                    <h4>2. Tipos de Despesas Reembolsáveis</h4>
                    <ul>
                        <li>Viagens</li>
                        <li>Diárias</li>
                        <li>Despesas operacionais vinculadas a projetos</li>
                    </ul>
                    <h3>Processo Detalhado de Reembolso</h3>
                    <h4>Etapa 1: Registro de Despesas</h4>
                    <ul>
                        <li>Documentar todas as despesas com comprovantes.</li>
                        <li>Categorizar despesas por projeto.</li>
                        <li>Manter registro detalhado.</li>
                    </ul>
                    <h4>Etapa 2: Emissão de Documentação</h4>
                    <ul>
                        <li><strong>Nota de Débito:</strong> Documento específico para reembolsos.</li>
                        <li>Não configura nota fiscal.</li>
                        <li>Serve como comprovante de cobrança.</li>
                    </ul>
                    <h4>Etapa 3: Tratamento Tributário</h4>
                    <ul>
                        <li><strong>Regra Crítica:</strong> Separar reembolso de faturamento para evitar tributação incorreta.</li>
                        <li><strong>Procedimento:</strong> O reembolso não pode ser incluído na nota fiscal; deve-se emitir um documento específico (Nota de Débito).</li>
                    </ul>
                    <h3>Documentação Necessária</h3>
                    <h4>Documentos para Reembolso</h4>
                    <ul>
                        <li>Comprovantes originais (enviar anexados à Nota de Débito).</li>
                        <li><span class="highlight">Importante: Não colocar CPF nas notas fiscais destinadas a reembolso.</span></li>
                        <li>Planilha detalhada de despesas.</li>
                        <li>Nota de débito (<a href="https://i4solucoeseconsultoriaemene-my.sharepoint.com/:w:/g/personal/consultoria_i4economicregulation_com_br/EWYJeY47jCZDrI7cBE6JguoB5QKAWywIDhmOlIo2xOnKCA?e=RsHYgi" target="_blank" class="text-blue-600 hover:underline">ver modelo</a>).</li>
                        <li>Registro do projeto associado.</li>
                    </ul>
                    <h4>Informações Obrigatórias na Nota de Débito</h4>
                    <ul>
                        <li>Projeto vinculado.</li>
                        <li>Descrição detalhada (ex: "Viagens e diárias").</li>
                        <li>Valor total.</li>
                        <li>Município relacionado.</li>
                    </ul>
                </div>

                <!-- New Tab for Activity Log -->
                <div id="activity-log" class="tab-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Registro de Atividades</h2>
                    <div id="activity-log-container" class="bg-gray-100 p-4 rounded-lg">
                        <!-- Activity log entries will be injected here -->
                        <p class="text-gray-500 text-center">Nenhuma atividade registrada ainda.</p>
                    </div>
                </div>
                
                <!-- Admin Panel Tab -->
                <div id="admin-panel" class="tab-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Painel do Administrador</h2>
                    <p class="text-gray-500 mb-4">Gerencie os usuários que podem acessar o painel.</p>

                    <div class="bg-gray-100 p-6 rounded-lg shadow-inner">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Convidar Novo Usuário</h3>
                        <div class="flex flex-col sm:flex-row gap-2 mb-4">
                            <input type="email" id="new-user-email" class="flex-grow border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="E-mail do novo usuário">
                            <button id="add-user-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Adicionar</button>
                        </div>
                        <p id="admin-message" class="text-center text-sm text-red-500"></p>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Usuários do Painel</h3>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">E-mail</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- User rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </section>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Confirmar Ação</h3>
            <p id="confirmation-modal-text" class="text-gray-600 mb-6">Tem certeza?</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="modal-confirm" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Observation Modal -->
    <div id="observation-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-lg">
            <h3 class="text-lg font-bold text-gray-800 mb-4 text-left">Editar Observação</h3>
            <input type="hidden" id="observation-entry-id">
            <textarea id="observation-textarea" class="w-full h-32 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Adicione suas observações aqui..."></textarea>
            <div class="flex justify-end gap-4 mt-4">
                <button id="modal-observation-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="modal-observation-save" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Reimbursement Edit Modal -->
    <div id="reimbursement-edit-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl text-left">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Editar Reembolso</h3>
            <input type="hidden" id="edit-reimbursement-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="edit-reimbursement-description" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <input type="text" id="edit-reimbursement-description" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="edit-reimbursement-requester" class="block text-sm font-medium text-gray-700">Solicitante</label>
                    <input type="text" id="edit-reimbursement-requester" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                 <div>
                    <label for="edit-reimbursement-beneficiary" class="block text-sm font-medium text-gray-700">Beneficiário</label>
                    <input type="text" id="edit-reimbursement-beneficiary" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="edit-reimbursement-project" class="block text-sm font-medium text-gray-700">Projeto</label>
                    <select id="edit-reimbursement-project" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                         <option value="energisa">Energisa</option>
                         <option value="equatorial">Equatorial</option>
                         <option value="light_sandbox">Light (Sandbox)</option>
                         <option value="light_pid">Light (P&D)</option>
                         <option value="pesquisadores">Pesquisadores</option>
                         <option value="geral">Geral/Administrativo</option>
                    </select>
                </div>
                <div>
                    <label for="edit-reimbursement-amount" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                    <input type="number" id="edit-reimbursement-amount" step="0.01" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="edit-reimbursement-date" class="block text-sm font-medium text-gray-700">Data da Despesa</label>
                    <input type="date" id="edit-reimbursement-date" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label for="edit-reimbursement-file" class="block text-sm font-medium text-gray-700">Comprovante</label>
                    <input type="text" id="edit-reimbursement-file" placeholder="Cole o link para o comprovante aqui" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="modal-reimbursement-edit-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="modal-reimbursement-edit-save" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Salvar</button>
            </div>
        </div>
    </div>


    <!-- Script para Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            onSnapshot,
            collection,
            query,
            orderBy,
            addDoc,
            serverTimestamp,
            getDoc,
            getDocs,
            where,
            limit,
            updateDoc, 
            deleteDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // SUA CONFIGURAÇÃO DO FIREBASE COPIADA DO CONSOLE
        const firebaseConfig = {
          apiKey: "AIzaSyDNCIQfJIfR5yIcXZYsxZeEvf4l3Kv35SU",
          authDomain: "painel-gestao-projetos-i-375d7.firebaseapp.com",
          projectId: "painel-gestao-projetos-i-375d7",
          storageBucket: "painel-gestao-projetos-i-375d7.firebasestorage.app",
          messagingSenderId: "141628345460",
          appId: "1:141628345460:web:b7f668b7c6eb91710b5521",
          measurementId: "G-5DKDMWJY3Y" 
        };
        
        const appId = firebaseConfig.projectId;

        // Inicialização do Firebase
        let app;
        let db;
        let auth;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Erro na inicialização do Firebase:", e);
        }

        // Definições do projeto e caminhos das coleções
        const KANBAN_COLLECTION_PATH = `artifacts/${appId}/public/data/kanban_state`;
        const TODO_COLLECTION_PATH = `artifacts/${appId}/public/data/todo_list`;
        const ACTIVITY_LOG_COLLECTION_PATH = `artifacts/${appId}/public/data/activity_log`;
        const USERS_COLLECTION_PATH = `artifacts/${appId}/public/data/users`;
        const FINANCIAL_COLLECTION_PATH = `artifacts/${appId}/public/data/financial_entries`;
        const PROJECT_OBSERVATIONS_PATH = `artifacts/${appId}/public/data/project_observations`;
        const REIMBURSEMENTS_COLLECTION_PATH = `artifacts/${appId}/public/data/reimbursements`;


        const initialProjectState = {
            energisa: { step: 0, name: "Sandbox Energisa" },
            equatorial: { step: 0, name: "Sandbox Equatorial" },
            light_sandbox: { step: 3, name: "Sandbox Light" },
            light_pid: { step: 0, name: "P&D Light (Por Sprint)" },
            pesquisadores: { step: 0, name: "Pagamento Pesquisadores" }
        };
        window.initialProjectState = initialProjectState;

        const workflows = {
            energisa: [
                { action: "Enviar Relatório de Acompanhamento", deadline: "Até dia 8" },
                { action: "Receber 'Documento de Medição'", deadline: "Até dia 17" },
                { action: "Emitir e Submeter a Nota Fiscal", deadline: "Até dia 23" },
                { action: "Pagamento em 60 dias. Ciclo concluído.", deadline: "N/A", final: true }
            ],
            equatorial: [
                { action: "Enviar Relatório de Avanço", deadline: "Até dia 1º" },
                { action: "Garantir assinatura do Gabardo", deadline: "Até dia 5" },
                { action: "Receber dados da NF da Jéssica", deadline: "Até dia 16" },
                { action: "Submeter NF na ROIT e enviar e-mail", deadline: "Até dia 23" },
                { action: "Ciclo do mês concluído.", deadline: "N/A", final: true }
            ],
            light_sandbox: [
                { action: "Prestar contas no Channel", deadline: "Até o último dia útil do mês" },
                { action: "Aprovar prestação de contas no Channel", deadline: "Após a submissão" },
                { action: "Solicitar faturamento no Channel", deadline: "Após a aprovação" },
                { action: "Receber o Documento de Medição", deadline: "Aguardando e-mail" },
                { action: "Solicitar NFe para a Cássia", deadline: "A definir" },
                { action: "Submeter a NFe na plataforma WebSupply", deadline: "Após emissão" },
                { action: "Faturamento concluído.", deadline: "N/A", final: true }
            ],
            light_pid: [
                { action: "Prestar contas no Channel", deadline: "Até o último dia útil do mês" },
                { action: "Verificar se há Faturamento neste mês", deadline: "Ao final da prestação de contas", dynamic: true },
                { action: "Aguardar aprovação do GP e dados da NF", deadline: "A definir" },
                { action: "Emitir e submeter fatura", deadline: "A definir" },
                { action: "Faturamento do Sprint concluído.", deadline: "N/A", final: true }
            ],
            pesquisadores: [
                { action: "Lembrar pesquisadores sobre emissão de NFs", deadline: "Até dia 1º" },
                { action: "Garantir que todos emitiram as NFs", deadline: "Até dia 7" },
                { action: "Enviar relação para pagamento ao Gabardo", deadline: "Antes do dia 10" },
                { action: "Pagamentos efetuados. Ciclo concluído.", deadline: "Dia 10", final: true }
            ]
        };
        window.workflows = workflows;
        
        let projectState = {};
        window.projectState = projectState;

        let todos = [];
        let activities = [];
        let financialEntries = [];
        let reimbursements = [];
        let projectObservations = {};
        let financialHealthChart = null;
        let financialTimeSeriesChart = null;


        // Filtros iniciais para a aba financeira
        let currentFinancialFilters = { type: 'all', status: 'all', project: 'all', year: 'all' }; 

        let activeProject = 'light_pid'; // Mantém o Light P&D como padrão inicial

        let userEmail;
        let isAdmin = false;

        // Variáveis para gerenciar as funções de unsubscribe dos listeners do Firestore
        let unsubscribeKanban = null;
        let unsubscribeTodos = null;
        let unsubscribeActivities = null;
        let unsubscribeUsers = null;
        let unsubscribeFinancial = null;
        let unsubscribeProjectObservations = null;
        let unsubscribeReimbursements = null;


        // --- FUNÇÕES DE PERSISTÊNCIA DE DADOS FIREBASE ---
        async function saveKanbanState() {
            if (userEmail) {
                const docRef = doc(db, KANBAN_COLLECTION_PATH, 'shared_state');
                await setDoc(docRef, { projects: projectState }, { merge: true });
            }
        }

        async function saveTodos() {
            if (userEmail) {
                const docRef = doc(db, TODO_COLLECTION_PATH, 'shared_todos');
                await setDoc(docRef, { todos: todos }, { merge: true });
            }
        }
        
        async function logActivity(description) {
            if (userEmail) {
                const activityRef = collection(db, ACTIVITY_LOG_COLLECTION_PATH);
                await addDoc(activityRef, {
                    user: userEmail,
                    description: description,
                    timestamp: serverTimestamp()
                });
            }
        }

        function listenForDataChanges() {
            // Primeiro, desinscreva listeners antigos se existirem para evitar duplicações
            if (unsubscribeKanban) unsubscribeKanban();
            if (unsubscribeTodos) unsubscribeTodos();
            if (unsubscribeActivities) unsubscribeActivities();
            if (unsubscribeFinancial) unsubscribeFinancial();
            if (unsubscribeUsers) unsubscribeUsers();
            if (unsubscribeProjectObservations) unsubscribeProjectObservations();
            if (unsubscribeReimbursements) unsubscribeReimbursements();

            if (userEmail) {
                // Listener para o estado do Kanban
                const kanbanRef = doc(db, KANBAN_COLLECTION_PATH, 'shared_state');
                unsubscribeKanban = onSnapshot(kanbanRef, (doc) => {
                    if (doc.exists()) {
                        projectState = doc.data().projects;
                        initializeBoard();
                    } else {
                        projectState = initialProjectState;
                        saveKanbanState();
                        initializeBoard();
                    }
                }, (error) => {
                    console.error("Erro ao ouvir estado do Kanban:", error);
                });

                // Listener para a lista de tarefas
                const todoRef = doc(db, TODO_COLLECTION_PATH, 'shared_todos');
                unsubscribeTodos = onSnapshot(todoRef, (doc) => {
                    if (doc.exists()) {
                        todos = doc.data().todos;
                        renderTodos();
                    } else {
                        todos = [];
                        renderTodos();
                    }
                }, (error) => {
                    console.error("Erro ao ouvir lista de tarefas:", error);
                });
                
                // Listener para o registro de atividades
                const activityQuery = query(collection(db, ACTIVITY_LOG_COLLECTION_PATH), orderBy("timestamp", "desc"), limit(20));
                unsubscribeActivities = onSnapshot(activityQuery, (snapshot) => {
                    activities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderActivityLog();
                }, (error) => {
                    console.error("Erro ao ouvir registro de atividades:", error);
                });

                // Listener para dados financeiros
                const financialQuery = query(collection(db, FINANCIAL_COLLECTION_PATH), orderBy("dueDate", "asc"));
                unsubscribeFinancial = onSnapshot(financialQuery, (snapshot) => {
                    financialEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateYearFilter();
                    renderFinancialDashboard();
                    renderGeneralFinancialSummary(); // Update the general tab as well
                }, (error) => {
                    console.error("Erro ao ouvir dados financeiros:", error);
                });

                // Listener para observações de projeto
                const projectObsQuery = collection(db, PROJECT_OBSERVATIONS_PATH);
                unsubscribeProjectObservations = onSnapshot(projectObsQuery, (snapshot) => {
                    projectObservations = {}; // Reset before populating
                    snapshot.forEach(doc => {
                        projectObservations[doc.id] = doc.data();
                    });
                    updateProjectObservationView();
                }, (error) => {
                    console.error("Erro ao ouvir observações de projeto:", error);
                });

                // Listener para reembolsos
                const reimbursementQuery = query(collection(db, REIMBURSEMENTS_COLLECTION_PATH), orderBy("requestDate", "desc"));
                unsubscribeReimbursements = onSnapshot(reimbursementQuery, (snapshot) => {
                    reimbursements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderReimbursements();
                }, (error) => {
                    console.error("Erro ao ouvir reembolsos:", error);
                });
            }
        }

        // --- LÓGICA DO PAINEL KANBAN ---
        function renderProjectKanban(projectId) {
            const projectData = projectState[projectId];

            if (!projectData || typeof projectData.step === 'undefined') {
                console.warn(`Estado do projeto '${projectId}' inválido ou ausente. Ignorando renderização.`);
                return;
            }

            const projectWorkflow = workflows[projectId];
            const currentStep = projectData.step; 
            
            document.getElementById(`col-${projectId}-todo`).innerHTML = `<h3 class="kanban-column-title"><i data-lucide="play-circle" class="mr-2 text-blue-500"></i>A Fazer</h3>`;
            document.getElementById(`col-${projectId}-in-progress`).innerHTML = `<h3 class="kanban-column-title"><i data-lucide="loader-2" class="mr-2 text-yellow-500"></i>Em Andamento</h3>`;
            document.getElementById(`col-${projectId}-done`).innerHTML = `<h3 class="kanban-column-title"><i data-lucide="check-circle-2" class="mr-2 text-green-500"></i>Concluído</h3>`;

            projectWorkflow.forEach((stepInfo, index) => {
                const card = document.createElement('div');
                card.className = `kanban-card`;

                if (index < currentStep) {
                    card.classList.add('completed-step');
                    document.getElementById(`col-${projectId}-done`).appendChild(card);
                } else if (index === currentStep) {
                    card.classList.add('current-step');
                    document.getElementById(`col-${projectId}-in-progress`).appendChild(card);
                } else {
                    document.getElementById(`col-${projectId}-todo`).appendChild(card);
                }

                let dynamicContent = ``;
                if (projectId === 'light_pid' && index === 1) {
                    if (currentStep === 1) {
                         dynamicContent = `
                            <div class="mt-4">
                                <p class="font-bold mb-2">Haverá Faturamento neste mês?</p>
                                <div class="flex flex-col gap-2">
                                    <button onclick="handlePIDChoice('${projectId}', true)" class="kanban-card-button bg-blue-500 hover:bg-blue-600">Sim, há Faturamento</button>
                                    <button onclick="handlePIDChoice('${projectId}', false)" class="kanban-card-button bg-red-500 hover:bg-red-600">Não, apenas Prestação de Contas</button>
                                </div>
                            </div>
                         `;
                    }
                }
                
                let advanceButtonHTML = '';
                if (index === currentStep && !stepInfo.final && !stepInfo.dynamic) {
                    advanceButtonHTML = `<button onclick="advanceStep('${projectId}')" class="kanban-card-button w-full mt-4">Concluir Etapa</button>`;
                } else if (index === currentStep && stepInfo.final) {
                     advanceButtonHTML = `<button disabled class="kanban-card-button w-full mt-4">Ciclo Concluído</button>`;
                }
                
                let backButtonHTML = '';
                if (index === currentStep && currentStep > 0 && !stepInfo.dynamic) {
                    const prevStepInfo = projectWorkflow[index - 1];
                    if (!prevStepInfo.dynamic) {
                        backButtonHTML = `<button onclick="revertStep('${projectId}')" class="kanban-card-button w-full mt-2 bg-gray-500 hover:bg-gray-600">Voltar Etapa</button>`;
                    }
                }

                card.innerHTML = `
                    <h4 class="font-bold text-gray-800">${stepInfo.action}</h4>
                    <div class="mt-3 text-xs font-medium text-gray-600 flex items-center">
                        <i data-lucide="calendar" class="inline-block h-3 w-3 mr-1"></i>
                        Prazo: <span class="deadline ml-1">${stepInfo.deadline}</span>
                    </div>
                    ${advanceButtonHTML}
                    ${backButtonHTML}
                    ${dynamicContent}
                `;
            });
            lucide.createIcons();
        }

        const initializeBoard = () => {
            for (const projectId in projectState) {
                renderProjectKanban(projectId);
            }
            updateDashboardSummary();
            renderGeneralView();
            showProjectKanban(activeProject || 'light_pid'); 
        }

        const updateDashboardSummary = () => {
            let completedCount = 0;
            let waitingCount = 0;
            for (const projectId in projectState) {
                const project = projectState[projectId];
                if (!workflows[projectId] || typeof project.step === 'undefined' || !workflows[projectId][project.step]) {
                    console.warn(`Dados incompletos para o projeto ${projectId} ao atualizar o resumo.`);
                    continue;
                }
                const lastStep = workflows[projectId].length - 1;
                if (project.step === lastStep) {
                    completedCount++;
                }
                const currentAction = workflows[projectId][project.step].action;
                if (currentAction.toLowerCase().includes('aguardar') || currentAction.toLowerCase().includes('receber')) {
                    waitingCount++;
                }
            }
            document.getElementById('completed-projects-count').textContent = completedCount;
            document.getElementById('waiting-projects-count').textContent = waitingCount;
        }

        const renderGeneralView = () => {
            const tableBody = document.getElementById('general-view-table-body');
            tableBody.innerHTML = '';

            if (Object.keys(projectState).length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Nenhum projeto para acompanhar.</td></tr>';
                 return;
            }

            for (const projectId in projectState) {
                const project = projectState[projectId];
                if (!workflows[projectId] || typeof project.step === 'undefined' || !workflows[projectId][project.step]) {
                    console.warn(`Dados incompletos para o projeto ${projectId} ao renderizar a visão geral.`);
                    continue;
                }

                const stepInfo = workflows[projectId][project.step];
                
                if (!stepInfo.final) {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-100 transition-colors duration-200';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${project.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stepInfo.action}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stepInfo.deadline}</td>
                    `;
                    tableBody.appendChild(row);
                }
            }
            if (tableBody.children.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Todos os projetos estão concluídos ou não configurados.</td></tr>';
            }
        }
        
        window.handlePIDChoice = async function(projectId, hasInvoice) {
            const project = projectState[projectId];
            if (hasInvoice) {
                 project.step = 2;
                 await logActivity(`informou que o projeto ${project.name} terá faturamento neste mês.`);
            } else {
                 project.step = workflows[projectId].length - 1;
                await logActivity(`informou que o projeto ${project.name} não terá faturamento neste mês.`);
            }
            await saveKanbanState();
        }
        
        window.advanceStep = async function(projectId) {
            const project = projectState[projectId];
            const currentAction = workflows[projectId][project.step].action;
            if (project.step < workflows[projectId].length - 1) {
                project.step++;
                await saveKanbanState();
                await logActivity(`avançou o projeto ${project.name}: "${currentAction}" para a próxima etapa.`);
            }
        }
        
        window.revertStep = async function(projectId) {
            const project = projectState[projectId];
            const revertedAction = workflows[projectId][project.step - 1].action;
            if (project.step > 0) {
                project.step--;
                await saveKanbanState();
                await logActivity(`reverteu o projeto ${project.name} para a etapa anterior: "${revertedAction}".`);
            }
        }

        window.showProjectKanban = function(projectId) {
            activeProject = projectId;
            document.querySelectorAll('.project-kanban-section').forEach(section => {
                section.classList.remove('active');
            });
            const targetKanbanSection = document.getElementById(`kanban-${projectId}`);
            if (targetKanbanSection) {
                targetKanbanSection.classList.add('active');
            } else {
                console.error(`Seção Kanban para ${projectId} não encontrada.`);
                return;
            }
            
            renderProjectKanban(projectId);

            document.querySelectorAll('.project-button').forEach(button => {
                button.classList.remove('bg-blue-500', 'text-white');
                button.classList.add('bg-gray-200', 'text-gray-800');

                if ((button.textContent.includes('Energisa') && projectId === 'energisa') ||
                    (button.textContent.includes('Equatorial') && projectId === 'equatorial') ||
                    (button.textContent.includes('Light (Sandbox)') && projectId === 'light_sandbox') ||
                    (button.textContent.includes('Light (P&D)') && projectId === 'light_pid') ||
                    (button.textContent.includes('Pesquisadores') && projectId === 'pesquisadores')) {
                    button.classList.add('bg-blue-500', 'text-white');
                    button.classList.remove('bg-gray-200', 'text-gray-800');
                }
            });
        }
        
        // --- LÓGICA DA LISTA DE TAREFAS ---
        const renderTodos = () => {
            const container = document.getElementById('todo-list-container');
            container.innerHTML = '';
            if (todos.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">Nenhuma tarefa pendente.</p>';
                return;
            }

            todos.forEach(todo => {
                const item = document.createElement('div');
                item.className = `todo-item ${todo.completed ? 'completed' : ''}`;
                item.dataset.id = todo.id;

                let deadlineHTML = '';
                if (todo.deadline) {
                    const [year, month, day] = todo.deadline.split('-');
                    deadlineHTML = `<span class="todo-deadline mt-1 text-xs text-gray-400">Prazo: ${day}/${month}/${year}</span>`;
                }

                item.innerHTML = `
                    <input type="checkbox" ${todo.completed ? 'checked' : ''}>
                    <div class="todo-details flex-grow">
                        <span class="todo-text">${todo.text}</span>
                        ${todo.assignee ? `<span class="assignee-tag">${todo.assignee}</span>` : ''}
                        ${deadlineHTML}
                    </div>
                    <button class="delete-todo"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                `;
                container.appendChild(item);
            });
            lucide.createIcons();
        }

        async function addTodo() {
            const input = document.getElementById('new-todo-input');
            const assigneeInput = document.getElementById('new-todo-assignee');
            const deadlineInput = document.getElementById('new-todo-deadline');
            const text = input.value.trim();
            const assignee = assigneeInput.value.trim();
            const deadline = deadlineInput.value.trim();

            if (!text) {
                alert('Por favor, digite a descrição da tarefa.');
                input.focus();
                return;
            }

            todos.push({ id: Date.now(), text, completed: false, assignee, deadline });
            input.value = '';
            assigneeInput.value = '';
            deadlineInput.value = '';
            await saveTodos();
            await logActivity(`adicionou a tarefa: "${text}" à lista de tarefas.`);
        }

        async function handleTodoClick(e) {
            const target = e.target;
            const item = target.closest('.todo-item');
            if (!item) return;

            const todoId = Number(item.dataset.id);
            const todo = todos.find(t => t.id === todoId);

            if (target.type === 'checkbox') {
                if(todo) {
                    todo.completed = target.checked;
                    await logActivity(`${todo.completed ? 'marcou' : 'desmarcou'} a tarefa: "${todo.text}" como concluída.`);
                }
            }

            if (target.closest('.delete-todo')) {
                const removedTodoText = todo.text;
                todos = todos.filter(t => t.id !== todoId);
                await logActivity(`removeu a tarefa: "${removedTodoText}" da lista.`);
            }
            
            await saveTodos();
        }
        
        // --- LÓGICA DO REGISTRO DE ATIVIDADES ---
        const renderActivityLog = () => {
            const container = document.getElementById('activity-log-container');
            container.innerHTML = '';
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">Nenhuma atividade registrada ainda.</p>';
                return;
            }

            activities.forEach(activity => {
                const logItem = document.createElement('div');
                logItem.className = 'bg-white p-4 rounded-lg shadow-sm mb-2';
                const date = activity.timestamp && activity.timestamp.toDate ? new Date(activity.timestamp.toDate()).toLocaleString('pt-BR') : 'Ainda não registrado';
                const userDisplay = activity.user ? activity.user.substring(0, activity.user.indexOf('@')) : 'Usuário Desconhecido';
                logItem.innerHTML = `
                    <p class="text-sm text-gray-800">
                        <span class="font-bold">${userDisplay}</span> ${activity.description}
                    </p>
                    <p class="text-xs text-gray-400 mt-1">${date}</p>
                `;
                container.appendChild(logItem);
            });
        }
        
        // --- LÓGICA DO PAINEL ADMIN ---
        const adminButton = document.getElementById('admin-button');
        const addUserButton = document.getElementById('add-user-button');
        const newUserEmailInput = document.getElementById('new-user-email');
        const adminMessage = document.getElementById('admin-message');
        
        addUserButton.addEventListener('click', async () => {
            const email = newUserEmailInput.value;
            if (!email || email.trim() === '') {
                adminMessage.textContent = 'Por favor, insira um e-mail.';
                return;
            }
            
            try {
                const usersRef = collection(db, USERS_COLLECTION_PATH);
                const q = query(usersRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    const newUserRef = doc(usersRef);
                    await setDoc(newUserRef, { email: email, status: 'pendente' });
                    
                    adminMessage.textContent = `Usuário ${email} adicionado. Ele poderá entrar no sistema após ser criado pelo administrador.`;
                    newUserEmailInput.value = '';
                    await logActivity(`adicionou o novo usuário: ${email}`);
                } else {
                    adminMessage.textContent = `Usuário ${email} já existe.`;
                }

            } catch (e) {
                adminMessage.textContent = `Erro ao adicionar usuário: ${e.message}`;
                console.error("Erro ao adicionar usuário:", e);
            }
        });
        
        const renderAdminPanel = () => {
            const usersTableBody = document.getElementById('users-table-body');
            usersTableBody.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-sm text-gray-500">Carregando usuários...</td></tr>';
            
            if (unsubscribeUsers) unsubscribeUsers();

            const usersRef = collection(db, USERS_COLLECTION_PATH);
            unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
                usersTableBody.innerHTML = '';
                if (snapshot.empty) {
                     usersTableBody.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-sm text-gray-500">Nenhum usuário registrado.</td></tr>';
                     return;
                }
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${userData.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${userData.status || 'ativo'}</td>
                    `;
                    usersTableBody.appendChild(row);
                });
            }, (error) => {
                console.error("Erro ao ouvir usuários no painel admin:", error);
                usersTableBody.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-sm text-red-500">Erro ao carregar usuários.</td></tr>';
            });
        }

        // --- LÓGICA DO PAINEL FINANCEIRO ---
        const formatCurrency = (value) => {
            if (typeof value !== 'number') {
                value = 0;
            }
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        };

        const projectNames = {
            energisa: 'Energisa',
            equatorial: 'Equatorial',
            light_sandbox: 'Light (Sandbox)',
            light_pid: 'Light (P&D)',
            pesquisadores: 'Pesquisadores',
            geral: 'Geral/Admin'
        };

        const getStatusBadgeClass = (status) => {
            switch (status) {
                case 'pending':
                case 'Pendente':
                     return 'status-pending';
                case 'paid':
                case 'received':
                case 'pago':
                case 'Pago':
                     return 'status-paid';
                case 'partially_paid':
                case 'partially_received': return 'status-partially_paid';
                case 'overdue': return 'status-overdue';
                default: return '';
            }
        };

        const getStatusDisplayName = (status) => {
            switch (status) {
                case 'pending': return 'Pendente';
                case 'paid': return 'Pago';
                case 'pago': return 'Pago';
                case 'received': return 'Recebido';
                case 'partially_paid': return 'Parcialmente Pago';
                case 'partially_received': return 'Parcialmente Recebido';
                case 'overdue': return 'Vencido';
                default: return status;
            }
        };

        const calculateFinancialSummary = (entries, prefix) => {
            let sumReceivablesExpected = 0;
            let sumReceivablesRealized = 0;
            let sumPaymentsExpected = 0;
            let sumPaymentsRealized = 0;

            entries.forEach(entry => {
                if (entry.type === 'receivable') {
                    sumReceivablesExpected += entry.expectedAmount || 0;
                    sumReceivablesRealized += entry.realizedAmount || 0;
                } else if (entry.type === 'payment') {
                    sumPaymentsExpected += entry.expectedAmount || 0;
                    sumPaymentsRealized += entry.realizedAmount || 0;
                }
            });

            // Calculations for the 6 boxes
            const totalFaturado = sumReceivablesRealized;
            const previstoFaturamento = sumReceivablesExpected - sumReceivablesRealized;
            const totalContratos = sumReceivablesExpected;
            const totalPago = sumPaymentsRealized;
            const previstoPagamento = sumPaymentsExpected - sumPaymentsRealized;
            const totalAPagar = sumPaymentsExpected;

            // DOM Updates for the 6 boxes
            document.getElementById(`${prefix}-total-faturado`).textContent = formatCurrency(totalFaturado);
            document.getElementById(`${prefix}-previsto-faturamento`).textContent = formatCurrency(previstoFaturamento);
            document.getElementById(`${prefix}-total-contratos`).textContent = formatCurrency(totalContratos);
            document.getElementById(`${prefix}-total-pago`).textContent = formatCurrency(totalPago);
            document.getElementById(`${prefix}-previsto-pagamento`).textContent = formatCurrency(previstoPagamento);
            document.getElementById(`${prefix}-total-a-pagar`).textContent = formatCurrency(totalAPagar);
            
            lucide.createIcons();
        };
        
        const populateYearFilter = () => {
            const yearFilter = document.getElementById('financial-filter-year');
            const years = new Set();
            financialEntries.forEach(entry => {
                if (entry.dueDate && entry.dueDate.toDate) {
                    years.add(entry.dueDate.toDate().getFullYear());
                }
            });

            const sortedYears = Array.from(years).sort((a, b) => b - a);
            const selectedValue = yearFilter.value;

            yearFilter.innerHTML = '<option value="all">Ano (Todos)</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            
            if (sortedYears.includes(parseInt(selectedValue))) {
                yearFilter.value = selectedValue;
            } else {
                yearFilter.value = 'all';
            }
        };

        const renderFinancialDashboard = () => {
            const tableBody = document.getElementById('financial-entries-table-body');
            tableBody.innerHTML = '';
            
            const filteredEntries = financialEntries.filter(entry => {
                const typeMatch = currentFinancialFilters.type === 'all' || entry.type === currentFinancialFilters.type;
                const projectMatch = currentFinancialFilters.project === 'all' || entry.projectId === currentFinancialFilters.project;
                
                // Safely check for dueDate and toDate method
                const entryYear = entry.dueDate && entry.dueDate.toDate ? entry.dueDate.toDate().getFullYear() : null;
                const yearMatch = currentFinancialFilters.year === 'all' || entryYear == currentFinancialFilters.year;

                let statusMatch = true;
                if (currentFinancialFilters.status !== 'all') {
                    let entryStatus = entry.status;
                    const today = new Date();
                    
                    if (entry.dueDate && entry.dueDate.toDate) {
                        const dueDate = entry.dueDate.toDate(); 
                        if (entryStatus === 'pending' && dueDate < today) {
                            entryStatus = 'overdue';
                        }
                    }
                    statusMatch = entryStatus === currentFinancialFilters.status;
                }
                
                return typeMatch && projectMatch && statusMatch && yearMatch;
            });

            if (filteredEntries.length === 0) {
                document.getElementById('no-financial-data').classList.remove('hidden');
                calculateFinancialSummary([], 'detalhado'); // Calculate with empty data for detailed tab
                return;
            } else {
                document.getElementById('no-financial-data').classList.add('hidden');
            }

            calculateFinancialSummary(filteredEntries, 'detalhado'); // Calculate for detailed tab

            filteredEntries.forEach(entry => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition-colors duration-200';
                
                let currentStatus = entry.status;
                const today = new Date();
                const dueDate = (entry.dueDate && entry.dueDate.toDate) ? entry.dueDate.toDate() : null;

                if (currentStatus === 'pending' && dueDate && dueDate < today) {
                    currentStatus = 'overdue';
                }

                const description = entry.description || 'N/A';
                const typeDisplay = entry.type === 'receivable' ? 'Faturamento' : 'Pagamento';
                const projectDisplay = projectNames[entry.projectId] || 'Geral';
                const expectedAmount = formatCurrency(entry.expectedAmount || 0);
                const realizedAmount = formatCurrency(entry.realizedAmount || 0);
                const dueDateDisplay = dueDate ? dueDate.toLocaleDateString('pt-BR') : 'N/A';
                
                const observationText = entry.observation || '';
                const truncatedObservation = observationText.length > 25 ? observationText.substring(0, 25) + '...' : observationText;
                const observationDisplay = observationText ? truncatedObservation : '<span class="text-gray-400">--</span>';

                row.innerHTML = `
                    <td class="px-3 py-4 text-sm text-gray-900">${description}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${typeDisplay}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${projectDisplay}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-right">${expectedAmount}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-right editable-cell" 
                        data-id="${entry.id}" data-field="realizedAmount" data-value="${entry.realizedAmount || 0}">
                        ${realizedAmount}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${dueDateDisplay}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-center">
                        <span class="financial-status-badge ${getStatusBadgeClass(currentStatus)}">${getStatusDisplayName(currentStatus)}</span>
                    </td>
                    <td class="px-3 py-4 text-sm text-gray-500">
                        <div class="flex items-center gap-2">
                            <span>${observationDisplay}</span>
                            <button title="Editar Observação" onclick="openObservationModal('${entry.id}', \`${observationText.replace(/`/g, '\\`')}\`)">
                                <i data-lucide="file-pen-line" class="h-4 w-4 text-gray-400 hover:text-blue-600"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 financial-actions">
                        ${currentStatus !== 'paid' && currentStatus !== 'received' ? `
                            <button title="Marcar como Concluído" onclick="toggleFinancialStatus('${entry.id}', ${entry.expectedAmount || 0}, '${entry.type}')">
                                <i data-lucide="check-circle" class="h-5 w-5 text-green-500"></i>
                            </button>
                        ` : ''}
                        <button title="Excluir" onclick="deleteFinancialEntry('${entry.id}', '${description}')">
                            <i data-lucide="trash-2" class="h-5 w-5 text-red-500"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            lucide.createIcons();

            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('click', function() {
                    if (this.classList.contains('editing')) return;
                    
                    this.classList.add('editing');
                    const originalValue = parseFloat(this.dataset.value);
                    
                    const numericValueForInput = originalValue.toFixed(2).replace('.', ',');

                    this.innerHTML = `<input type="text" value="${numericValueForInput}" />`;
                    const input = this.querySelector('input');
                    input.focus();
                    input.select();

                    input.addEventListener('blur', async () => {
                        let newValue = input.value.trim().replace(',', '.');
                        newValue = parseFloat(newValue) || 0;

                        if (newValue !== originalValue) {
                            await updateFinancialRealizedAmount(this.dataset.id, newValue);
                        }
                        this.classList.remove('editing');
                    });

                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            input.blur();
                        }
                    });
                });
            });
        };

        const renderGeneralFinancialSummary = () => {
            // Update summary cards on general tab
            calculateFinancialSummary(financialEntries, 'geral');

            // --- Update summary table ---
            const projectSummary = {};
            financialEntries.forEach(entry => {
                const projectId = entry.projectId;
                if (!projectSummary[projectId]) {
                    projectSummary[projectId] = { receivables: 0, payments: 0 };
                }
                if (entry.type === 'receivable') {
                    projectSummary[projectId].receivables += entry.expectedAmount || 0;
                } else if (entry.type === 'payment') {
                    projectSummary[projectId].payments += entry.expectedAmount || 0;
                }
            });

            const summaryTableBody = document.getElementById('geral-financial-summary-table-body');
            summaryTableBody.innerHTML = '';
            for (const projectId in projectSummary) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-800">${projectNames[projectId] || projectId}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-right">${formatCurrency(projectSummary[projectId].receivables)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-right">${formatCurrency(projectSummary[projectId].payments)}</td>
                `;
                summaryTableBody.appendChild(row);
            }

            // --- Update chart ---
            let sumReceivablesExpected = 0;
            let sumReceivablesRealized = 0;
            let sumPaymentsExpected = 0;
            let sumPaymentsRealized = 0;
            
            const monthlyData = {}; // Para o gráfico de séries temporais

            financialEntries.forEach(entry => {
                 if (entry.type === 'receivable') {
                    sumReceivablesExpected += entry.expectedAmount || 0;
                    sumReceivablesRealized += entry.realizedAmount || 0;
                } else if (entry.type === 'payment') {
                    sumPaymentsExpected += entry.expectedAmount || 0;
                    sumPaymentsRealized += entry.realizedAmount || 0;
                }

                // Processamento para o gráfico de séries temporais
                // Usar transactionDate se disponível e o status for pago/recebido, senão usar dueDate se realizado > 0
                let relevantDate = null;
                // --- MODIFICAÇÃO ---
                // Mudar a lógica para USAR SEMPRE a data de vencimento (dueDate) para o eixo do tempo
                // Isso garante que o valor realizado seja plotado no mês a que se refere (vencimento)
                // e não no mês em que foi pago (data da transação).
                if (entry.dueDate && entry.dueDate.toDate) {
                     relevantDate = entry.dueDate.toDate(); 
                }
                
                /* LÓGICA ANTIGA (REMOVIDA)
                if ((entry.status === 'paid' || entry.status === 'received' || entry.status === 'partially_paid' || entry.status === 'partially_received') && entry.transactionDate && entry.transactionDate.toDate) {
                     relevantDate = entry.transactionDate.toDate();
                } else if (entry.realizedAmount > 0 && entry.dueDate && entry.dueDate.toDate) {
                     relevantDate = entry.dueDate.toDate(); // Fallback para dueDate se realizado mas sem data de transação
                }
                */

                if (relevantDate && entry.realizedAmount > 0) { // Adicionada verificação de entry.realizedAmount > 0
                    const monthYear = `${relevantDate.getFullYear()}-${(relevantDate.getMonth() + 1).toString().padStart(2, '0')}`; // Formato: YYYY-MM

                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = {
                            faturamentoRealizado: 0,
                            pagamentoRealizado: 0,
                        };
                    }

                    if (entry.type === 'receivable') {
                        monthlyData[monthYear].faturamentoRealizado += entry.realizedAmount || 0;
                    } else if (entry.type === 'payment') {
                        monthlyData[monthYear].pagamentoRealizado += entry.realizedAmount || 0;
                    }
                }
            });
            
            const previstoFaturamento = sumReceivablesExpected - sumReceivablesRealized;
            const previstoPagamento = sumPaymentsExpected - sumPaymentsRealized;


            const ctx = document.getElementById('financial-health-chart').getContext('2d');
            if (financialHealthChart) {
                financialHealthChart.destroy();
            }
            financialHealthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Faturamento', 'Pagamentos'],
                    datasets: [{
                        label: 'Realizado',
                        data: [sumReceivablesRealized, sumPaymentsRealized],
                        backgroundColor: 'rgba(34, 197, 94, 0.7)', // Green
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Pendente',
                        data: [previstoFaturamento, previstoPagamento],
                        backgroundColor: 'rgba(251, 191, 36, 0.7)', // Yellow
                        borderColor: 'rgba(251, 191, 36, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        y: {
                            stacked: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });

            // --- NEW Time Series Chart Logic ---
            const sortedLabels = Object.keys(monthlyData).sort();
            
            const chartLabels = sortedLabels.map(label => {
                const [year, month] = label.split('-');
                const shortYear = year.substring(2);
                const monthName = new Date(year, month - 1, 1).toLocaleString('pt-BR', { month: 'short' });
                return `${monthName}/${shortYear}`; // e.g., "jan/24"
            });

            const faturamentoRealizadoData = sortedLabels.map(label => monthlyData[label].faturamentoRealizado);
            const pagamentoRealizadoData = sortedLabels.map(label => monthlyData[label].pagamentoRealizado);
            
            const ctxTs = document.getElementById('financial-timeseries-chart').getContext('2d');
            if (financialTimeSeriesChart) {
                financialTimeSeriesChart.destroy();
            }

            financialTimeSeriesChart = new Chart(ctxTs, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'Faturamento Realizado',
                            data: faturamentoRealizadoData,
                            borderColor: 'rgba(34, 197, 94, 1)', // Green
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Pagamento Realizado',
                            data: pagamentoRealizadoData,
                            borderColor: 'rgba(239, 68, 68, 1)', // Red
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) { return formatCurrency(value); }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        };

        async function updateFinancialRealizedAmount(entryId, newRealizedValue) {
            const entryRef = doc(db, FINANCIAL_COLLECTION_PATH, entryId);
            const entry = financialEntries.find(e => e.id === entryId);

            if (!entry) {
                console.error(`Entrada financeira com ID ${entryId} não encontrada.`);
                return;
            }

            let newStatus = entry.status;
            let transactionDate = entry.transactionDate || null;

            if (newRealizedValue >= entry.expectedAmount && entry.expectedAmount > 0) {
                newStatus = entry.type === 'receivable' ? 'received' : 'paid';
                transactionDate = serverTimestamp(); // Set transaction date on completion
            } else if (newRealizedValue > 0 && newRealizedValue < entry.expectedAmount) {
                newStatus = entry.type === 'receivable' ? 'partially_received' : 'partially_paid';
                transactionDate = serverTimestamp(); // Set transaction date on partial payment
            } else if (newRealizedValue === 0 && entry.expectedAmount > 0) {
                newStatus = 'pending';
                transactionDate = null; // Clear transaction date if reset to 0
            } else if (newRealizedValue === 0 && entry.expectedAmount === 0) {
                 newStatus = 'pending';
                 transactionDate = null;
            }

            try {
                await updateDoc(entryRef, {
                    realizedAmount: newRealizedValue,
                    status: newStatus,
                    transactionDate: transactionDate,
                    lastUpdated: serverTimestamp()
                });
                await logActivity(`atualizou o valor realizado para "${entry.description}" para ${formatCurrency(newRealizedValue)}.`);
            } catch (error) {
                console.error("Erro ao atualizar valor realizado:", error);
                alert("Erro ao atualizar valor: " + error.message);
            }
        }

        async function toggleFinancialStatus(entryId, expectedAmount, type) {
            if (confirm("Tem certeza que deseja marcar esta entrada como 'Concluída' (Paga/Recebida)?")) {
                const entryRef = doc(db, FINANCIAL_COLLECTION_PATH, entryId);
                let newStatus;
                if (type === 'receivable') {
                    newStatus = 'received';
                } else {
                    newStatus = 'paid';
                }
                
                try {
                    await updateDoc(entryRef, {
                        realizedAmount: expectedAmount,
                        status: newStatus,
                        transactionDate: serverTimestamp(),
                        lastUpdated: serverTimestamp()
                    });
                    await logActivity(`marcou "${financialEntries.find(e => e.id === entryId).description}" como ${getStatusDisplayName(newStatus)}.`);
                } catch (error) {
                    console.error("Erro ao marcar status financeiro:", error);
                    alert("Erro ao marcar status: " + error.message);
                }
            }
        }

        async function deleteFinancialEntry(entryId, description) {
            if (confirm(`Tem certeza que deseja excluir a entrada financeira: "${description}"?`)) {
                try {
                    const entryRef = doc(db, FINANCIAL_COLLECTION_PATH, entryId);
                    await deleteDoc(entryRef);
                    await logActivity(`excluiu a entrada financeira: "${description}".`);
                } catch (error) {
                    console.error("Erro ao excluir entrada financeira:", error);
                    alert("Erro ao excluir: " + error.message);
                }
            }
        }

        async function saveObservation() {
            const entryId = document.getElementById('observation-entry-id').value;
            const newObservation = document.getElementById('observation-textarea').value.trim();

            if (!entryId) return;

            try {
                const entryRef = doc(db, FINANCIAL_COLLECTION_PATH, entryId);
                await updateDoc(entryRef, {
                    observation: newObservation,
                    lastUpdated: serverTimestamp()
                });
                await logActivity(`atualizou a observação para o lançamento financeiro.`);
                closeObservationModal();
            } catch (error) {
                console.error("Erro ao salvar observação:", error);
                alert("Erro ao salvar observação: " + error.message);
            }
        }
        
        async function saveProjectObservation() {
            const selectedProject = document.getElementById('financial-filter-project').value;
            const observationText = document.getElementById('project-observation-textarea').value;
            const saveButton = document.getElementById('save-project-observation-button');

            if (!selectedProject || selectedProject === 'all') {
                alert('Selecione um projeto para salvar a observação.');
                return;
            }
            
            const originalButtonText = saveButton.textContent;
            saveButton.textContent = 'Salvando...';
            saveButton.disabled = true;

            try {
                const docRef = doc(db, PROJECT_OBSERVATIONS_PATH, selectedProject);
                await setDoc(docRef, { 
                    observation: observationText,
                    lastUpdated: serverTimestamp(),
                    updatedBy: userEmail
                }, { merge: true });
                await logActivity(`atualizou as observações para o projeto ${projectNames[selectedProject] || selectedProject}.`);
                
                saveButton.textContent = 'Salvo!';
                setTimeout(() => {
                    saveButton.textContent = originalButtonText;
                    saveButton.disabled = false;
                }, 2000);

            } catch (error) {
                console.error("Erro ao salvar observação do projeto:", error);
                alert("Erro ao salvar: " + error.message);
                saveButton.textContent = originalButtonText;
                saveButton.disabled = false;
            }
        }

        function openObservationModal(entryId, currentObservation) {
            document.getElementById('observation-entry-id').value = entryId;
            document.getElementById('observation-textarea').value = currentObservation;
            document.getElementById('observation-modal').classList.add('visible');
        }

        function closeObservationModal() {
            document.getElementById('observation-modal').classList.remove('visible');
        }

        function updateProjectObservationView() {
            const selectedProject = document.getElementById('financial-filter-project').value;
            const observationSection = document.getElementById('project-observation-section');
            const observationTitle = document.getElementById('project-observation-title');
            const observationTextarea = document.getElementById('project-observation-textarea');

            if (selectedProject && selectedProject !== 'all') {
                observationTitle.textContent = `Observações do Projeto: ${projectNames[selectedProject] || selectedProject}`;
                const observationData = projectObservations[selectedProject];
                observationTextarea.value = observationData ? observationData.observation || '' : '';
                observationSection.classList.remove('hidden');
            } else {
                observationSection.classList.add('hidden');
            }
        }
        
        window.toggleFinancialStatus = toggleFinancialStatus;
        window.deleteFinancialEntry = deleteFinancialEntry;
        window.openObservationModal = openObservationModal;

        // --- LÓGICA DE REEMBOLSOS ---
        const renderReimbursements = () => {
            const tableBody = document.getElementById('reimbursements-table-body');
            tableBody.innerHTML = '';
            if (reimbursements.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-4 text-center text-gray-500">Nenhuma solicitação de reembolso encontrada.</td></tr>';
                return;
            }

            reimbursements.forEach(reimbursement => {
                const row = document.createElement('tr');
                row.dataset.id = reimbursement.id;
                const expenseDate = reimbursement.expenseDate ? new Date(reimbursement.expenseDate.split('-').join('/')).toLocaleDateString('pt-BR') : 'N/A';
                
                let actionsHTML = '';
                if (reimbursement.status === 'Pendente') {
                    actionsHTML = `
                        <button onclick="openReimbursementEditModal('${reimbursement.id}')" class="text-blue-600 hover:text-blue-800 p-1"><i data-lucide="edit" class="h-4 w-4"></i></button>
                        <button onclick="deleteReimbursement('${reimbursement.id}')" class="text-red-600 hover:text-red-800 p-1"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                        <button onclick="updateReimbursementStatus('${reimbursement.id}')" class="bg-green-100 text-green-700 hover:bg-green-200 font-bold py-1 px-2 rounded-md text-xs ml-2">Pagar</button>
                    `;
                } else if (reimbursement.status === 'Pago') {
                    const paymentDate = reimbursement.paymentDate ? new Date(reimbursement.paymentDate.toDate()).toLocaleDateString('pt-BR') : '';
                    actionsHTML = `
                        <div class="flex items-center justify-center gap-2">
                            <span class="text-xs text-gray-600">${paymentDate}</span>
                            <button onclick="revertReimbursementStatus('${reimbursement.id}')" class="bg-yellow-100 text-yellow-800 hover:bg-yellow-200 font-bold py-1 px-2 rounded-md text-xs">Reverter</button>
                        </div>
                    `;
                } else {
                    actionsHTML = reimbursement.paymentDate ? new Date(reimbursement.paymentDate.toDate()).toLocaleDateString('pt-BR') : 'Data Indisponível';
                }

                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-800">${reimbursement.description}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${reimbursement.beneficiary}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${projectNames[reimbursement.projectId] || reimbursement.projectId}</td>
                    <td class="px-4 py-3 text-sm text-gray-800 text-right">${formatCurrency(reimbursement.amount)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${expenseDate}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="financial-status-badge ${getStatusBadgeClass(reimbursement.status)}">${getStatusDisplayName(reimbursement.status)}</span>
                    </td>
                    <td class="px-4 py-3 text-center text-sm">${actionsHTML}</td>
                `;
                tableBody.appendChild(row);
            });
            lucide.createIcons();
        };

        const addReimbursement = async () => {
            const description = document.getElementById('reimbursement-description').value;
            const requester = document.getElementById('reimbursement-requester').value;
            const beneficiary = document.getElementById('reimbursement-beneficiary').value;
            const projectId = document.getElementById('reimbursement-project').value;
            const amount = parseFloat(document.getElementById('reimbursement-amount').value);
            const expenseDate = document.getElementById('reimbursement-date').value;
            const receiptUrl = document.getElementById('reimbursement-file').value;

            if (!description || !requester || !beneficiary || !amount || !expenseDate) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            try {
                await addDoc(collection(db, REIMBURSEMENTS_COLLECTION_PATH), {
                    description,
                    requester,
                    beneficiary,
                    projectId,
                    amount,
                    expenseDate,
                    receiptUrl,
                    status: 'Pendente',
                    requestDate: serverTimestamp(),
                    paymentDate: null
                });
                await logActivity(`solicitou um reembolso de ${formatCurrency(amount)} para "${description}".`);
                
                // Clear form
                document.getElementById('reimbursement-description').value = '';
                document.getElementById('reimbursement-requester').value = '';
                document.getElementById('reimbursement-beneficiary').value = '';
                document.getElementById('reimbursement-amount').value = '';
                document.getElementById('reimbursement-date').value = '';
                document.getElementById('reimbursement-file').value = '';
            } catch(error) {
                console.error("Erro ao adicionar reembolso:", error);
                alert("Não foi possível adicionar o reembolso. Verifique o console para mais detalhes.");
            }
        };

        window.updateReimbursementStatus = async (id) => {
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationText = document.getElementById('confirmation-modal-text');
            const confirmButton = document.getElementById('modal-confirm');
            confirmationText.textContent = 'Tem certeza que deseja marcar este reembolso como pago?';
            confirmationModal.classList.add('visible');

            confirmButton.onclick = async () => {
                try {
                    const docRef = doc(db, REIMBURSEMENTS_COLLECTION_PATH, id);
                    await updateDoc(docRef, {
                        status: 'Pago',
                        paymentDate: serverTimestamp()
                    });
                    await logActivity(`marcou um reembolso como pago.`);
                } catch (error) {
                     console.error("Erro ao atualizar status do reembolso:", error);
                     alert("Não foi possível atualizar o status.");
                } finally {
                    confirmationModal.classList.remove('visible');
                }
            };
        };

        window.revertReimbursementStatus = async (id) => {
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationText = document.getElementById('confirmation-modal-text');
            const confirmButton = document.getElementById('modal-confirm');
            confirmationText.textContent = 'Tem certeza que deseja reverter este pagamento para "Pendente"?';
            confirmationModal.classList.add('visible');

            confirmButton.onclick = async () => {
                try {
                    const docRef = doc(db, REIMBURSEMENTS_COLLECTION_PATH, id);
                    await updateDoc(docRef, {
                        status: 'Pendente',
                        paymentDate: null
                    });
                    await logActivity(`reverteu o pagamento de um reembolso para "Pendente".`);
                } catch (error) {
                     console.error("Erro ao reverter status do reembolso:", error);
                     alert("Não foi possível reverter o status.");
                } finally {
                    confirmationModal.classList.remove('visible');
                }
            };
        };

        window.deleteReimbursement = async (id) => {
             const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationText = document.getElementById('confirmation-modal-text');
            const confirmButton = document.getElementById('modal-confirm');
            confirmationText.textContent = 'Tem certeza que deseja cancelar este reembolso? Esta ação não pode ser desfeita.';
            confirmationModal.classList.add('visible');
            
            confirmButton.onclick = async () => {
                 try {
                    const docRef = doc(db, REIMBURSEMENTS_COLLECTION_PATH, id);
                    await deleteDoc(docRef);
                    await logActivity(`cancelou uma solicitação de reembolso.`);
                } catch (error) {
                    console.error("Erro ao cancelar reembolso:", error);
                    alert("Não foi possível cancelar o reembolso.");
                } finally {
                    confirmationModal.classList.remove('visible');
                }
            };
        };
        
        const reimbursementEditModal = document.getElementById('reimbursement-edit-modal');
        
        window.openReimbursementEditModal = (id) => {
            const reimbursement = reimbursements.find(r => r.id === id);
            if(reimbursement) {
                document.getElementById('edit-reimbursement-id').value = id;
                document.getElementById('edit-reimbursement-description').value = reimbursement.description;
                document.getElementById('edit-reimbursement-requester').value = reimbursement.requester;
                document.getElementById('edit-reimbursement-beneficiary').value = reimbursement.beneficiary;
                document.getElementById('edit-reimbursement-project').value = reimbursement.projectId;
                document.getElementById('edit-reimbursement-amount').value = reimbursement.amount;
                document.getElementById('edit-reimbursement-date').value = reimbursement.expenseDate;
                document.getElementById('edit-reimbursement-file').value = reimbursement.receiptUrl;
                reimbursementEditModal.classList.add('visible');
            }
        };

        const closeReimbursementEditModal = () => {
            reimbursementEditModal.classList.remove('visible');
        };

        const saveReimbursementEdit = async () => {
            const id = document.getElementById('edit-reimbursement-id').value;
            const updatedData = {
                description: document.getElementById('edit-reimbursement-description').value,
                requester: document.getElementById('edit-reimbursement-requester').value,
                beneficiary: document.getElementById('edit-reimbursement-beneficiary').value,
                projectId: document.getElementById('edit-reimbursement-project').value,
                amount: parseFloat(document.getElementById('edit-reimbursement-amount').value),
                expenseDate: document.getElementById('edit-reimbursement-date').value,
                receiptUrl: document.getElementById('edit-reimbursement-file').value,
                lastUpdated: serverTimestamp()
            };

            if (!updatedData.description || !updatedData.requester || !updatedData.beneficiary || !updatedData.amount || !updatedData.expenseDate) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            try {
                const docRef = doc(db, REIMBURSEMENTS_COLLECTION_PATH, id);
                await updateDoc(docRef, updatedData);
                await logActivity(`editou uma solicitação de reembolso.`);
                closeReimbursementEditModal();
            } catch (error) {
                console.error("Erro ao salvar edição do reembolso:", error);
                alert("Não foi possível salvar as alterações.");
            }
        };

        document.getElementById('modal-reimbursement-edit-cancel').addEventListener('click', closeReimbursementEditModal);
        document.getElementById('modal-reimbursement-edit-save').addEventListener('click', saveReimbursementEdit);


        // Event Listeners
        document.getElementById('modal-observation-cancel').addEventListener('click', closeObservationModal);
        document.getElementById('modal-observation-save').addEventListener('click', saveObservation);
        document.getElementById('save-project-observation-button').addEventListener('click', saveProjectObservation);

        document.getElementById('financial-filter-type').addEventListener('change', (e) => {
            currentFinancialFilters.type = e.target.value;
            renderFinancialDashboard();
        });

        document.getElementById('financial-filter-status').addEventListener('change', (e) => {
            currentFinancialFilters.status = e.target.value;
            renderFinancialDashboard();
        });

        document.getElementById('financial-filter-project').addEventListener('change', (e) => {
            currentFinancialFilters.project = e.target.value;
            renderFinancialDashboard();
            updateProjectObservationView();
        });

        document.getElementById('financial-filter-year').addEventListener('change', (e) => {
            currentFinancialFilters.year = e.target.value;
            renderFinancialDashboard();
        });

        document.getElementById('clear-financial-filters').addEventListener('click', () => {
            currentFinancialFilters = { type: 'all', status: 'all', project: 'all', year: 'all' };
            document.getElementById('financial-filter-type').value = 'all';
            document.getElementById('financial-filter-status').value = 'all';
            document.getElementById('financial-filter-project').value = 'all';
            document.getElementById('financial-filter-year').value = 'all';
            renderFinancialDashboard();
            updateProjectObservationView();
        });

        const modal = document.getElementById('confirmation-modal');
        document.getElementById('reset-button').addEventListener('click', () => {
            document.getElementById('confirmation-modal-text').textContent = 'Tem certeza que deseja reiniciar o ciclo de todos os projetos para a primeira etapa?';
            modal.classList.add('visible');
            document.getElementById('modal-confirm').onclick = async () => {
                 for (const projectId in projectState) {
                    projectState[projectId].step = 0;
                }
                await saveKanbanState();
                modal.classList.remove('visible');
                await logActivity(`reiniciou o ciclo mensal de todos os projetos.`);
            };
        });
        document.getElementById('modal-cancel').addEventListener('click', () => modal.classList.remove('visible'));


        window.changeTab = function(event, tabID) {
            document.querySelectorAll(".tab-content").forEach(tab => {
                tab.classList.remove("active");
            });
            document.querySelectorAll(".tab-button").forEach(button => button.classList.remove("active"));
            
            document.getElementById(tabID).classList.add("active");
            event.currentTarget.classList.add("active");
            
            if (tabID !== 'admin-panel' && unsubscribeUsers) {
                unsubscribeUsers();
                unsubscribeUsers = null;
            }
            
            if(tabID === 'acompanhamento-geral'){
                renderGeneralFinancialSummary();
            } else if (tabID === 'kanban-por-projeto') {
                 showProjectKanban(activeProject || 'light_pid');
            } else if (tabID === 'admin-panel') {
                renderAdminPanel();
            } else if (tabID === 'financeiro') {
                renderFinancialDashboard();
                updateProjectObservationView();
            } else if (tabID === 'reembolsos') {
                renderReimbursements();
            }
        }

        // --- LÓGICA DE AUTENTICAÇÃO ---
        const authSection = document.getElementById('auth-section');
        const mainDashboard = document.getElementById('main-dashboard');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const authMessage = document.getElementById('auth-message');
        
        const adminEmail = "admin@admin.com"; 
        
        loginButton.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                authMessage.textContent = 'Por favor, preencha todos os campos.';
                return;
            }

            try {
                if (!auth) {
                    authMessage.textContent = 'Erro de inicialização: o serviço de autenticação não está disponível.';
                    console.error("Firebase Auth not initialized.");
                    return;
                }
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                 if (error.code === 'auth/invalid-credential') {
                     authMessage.textContent = 'E-mail ou senha inválidos.';
                 } else {
                    authMessage.textContent = `Erro no login: ${error.message}`;
                 }
                console.error("Login error:", error);
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                if (unsubscribeKanban) unsubscribeKanban();
                if (unsubscribeTodos) unsubscribeTodos();
                if (unsubscribeActivities) unsubscribeActivities();
                if (unsubscribeUsers) unsubscribeUsers(); 
                if (unsubscribeFinancial) unsubscribeFinancial();
                if (unsubscribeProjectObservations) unsubscribeProjectObservations();
                if (unsubscribeReimbursements) unsubscribeReimbursements();

            } catch (error) {
                console.error("Logout error:", error);
            }
        });
        
        const togglePassword = document.getElementById('toggle-password');
        togglePassword.addEventListener('click', function (e) {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            const eyeIcon = this.querySelector('svg');
            if (eyeIcon) {
                eyeIcon.setAttribute('data-lucide', type === 'password' ? 'eye' : 'eye-off');
            }
            lucide.createIcons();
        });


        // --- INICIALIZAÇÃO ---
        async function initApp() {
            try {
                if (!auth) {
                    console.error("Firebase Auth não foi inicializado. Verifique sua firebaseConfig.");
                    authSection.classList.remove('hidden');
                    mainDashboard.classList.add('hidden');
                    return;
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userEmail = user.email;
                        document.getElementById('user-email').textContent = userEmail;
                        authSection.classList.add('hidden');
                        mainDashboard.classList.remove('hidden');

                        isAdmin = (user.email === adminEmail);
                        if (isAdmin) {
                            adminButton.classList.remove('hidden');
                        } else {
                            adminButton.classList.add('hidden');
                        }
                        
                        const kanbanRef = doc(db, KANBAN_COLLECTION_PATH, 'shared_state');
                        const kanbanSnap = await getDoc(kanbanRef);
                        if (!kanbanSnap.exists()) {
                            await setDoc(kanbanRef, { projects: initialProjectState });
                            projectState = initialProjectState;
                        } else {
                            projectState = kanbanSnap.data().projects;
                        }
                        
                        const todoRef = doc(db, TODO_COLLECTION_PATH, 'shared_todos');
                        const todoSnap = await getDoc(todoRef);
                        if (todoSnap.exists()) {
                             todos = todoSnap.data().todos;
                        }

                        listenForDataChanges();
                        initializeBoard();
                        renderTodos();
                        renderActivityLog();
                        renderGeneralFinancialSummary();
                        renderReimbursements();

                    } else {
                        userEmail = null;
                        authSection.classList.remove('hidden');
                        mainDashboard.classList.add('hidden');
                        document.getElementById('user-email').textContent = 'Anônimo';
                        projectState = {};
                        todos = [];
                        activities = [];
                        financialEntries = [];
                        projectObservations = {};
                        reimbursements = [];
                        if (unsubscribeKanban) unsubscribeKanban();
                        if (unsubscribeTodos) unsubscribeTodos();
                        if (unsubscribeActivities) unsubscribeActivities();
                        if (unsubscribeUsers) unsubscribeUsers();
                        if (unsubscribeFinancial) unsubscribeFinancial();
                        if (unsubscribeProjectObservations) unsubscribeProjectObservations();
                        if (unsubscribeReimbursements) unsubscribeReimbursements();
                    }
                });

            } catch (e) {
                console.error("Erro na inicialização da aplicação ou Firebase:", e);
                authSection.classList.remove('hidden');
                mainDashboard.classList.add('hidden');
            }
            
            document.getElementById('add-todo-button').addEventListener('click', addTodo);
            document.getElementById('new-todo-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') addTodo(); });
            document.getElementById('new-todo-assignee').addEventListener('keypress', (e) => { if (e.key === 'Enter') addTodo(); });
            document.getElementById('new-todo-deadline').addEventListener('keypress', (e) => { if (e.key === 'Enter') addTodo(); });
            document.getElementById('todo-list-container').addEventListener('click', handleTodoClick);
            document.getElementById('add-reimbursement-button').addEventListener('click', addReimbursement);
        }
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

